<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Remind.me</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="navbar"></div>
    <div class="daily-quote">
      <h1 class="headerLeftAlign">Today's Quote is...</h1>
      <div class="quote-box" id="quote-box"></div>
    </div>

    <div class="user-input">
      <div class="song-input-header">
        Share a song or podcast that makes you think of today's quote!
      </div>
      <div class="input-area">
        <form id="user-form">
          <div>
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required />
          </div>
          <br />
          <div>
            <label for="podcast-song">Podcast/Song:</label>
            <input type="text" id="podcast-song" name="podcast-song" required />
          </div>
          <br />
          <div>
            <button type="submit">Search</button>
          </div>
        </form>
        <div class="results" id="results">
          <h3 class="results-header">Results</h3>
          <div id="results-list"></div>
        </div>
        <div class="saved" id="saved">
          <h3 class="saved-header">To Add</h3>
          <div id="saved-list"></div>
          <button class="saved-btn">Submit</button>
        </div>
        <script type="module" src="search-song.js"></script>
      </div>
    </div>

    <script type="module">
      import { EventHub } from "./source/eventhub/EventHub.js";
      import { Events } from "./source/eventhub/Events.js";
      import { TaskDatabase } from "./originalDatabase.js";
      import SpotifyLogin from "./SpotifyLogin.js";

      fetch("navbar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("navbar").innerHTML = data;

          const navLinkEls = document.querySelectorAll(".nav__link");
          const windowPathname = window.location.pathname;

          navLinkEls.forEach((navLinkEl) => {
            if (navLinkEl.href.includes(windowPathname)) {
              navLinkEl.classList.add("active");
            }
          });
        })
        .catch((error) => console.error("Error loading navbar:", error));

      let db = new TaskDatabase("quotesDB");

      // Modified loadQuote() function to utilize an API, as opposed to prior implementation with mocked quote data
      async function loadQuote() { 
        let currentDay = new Date().toLocaleDateString();
        await db.openDatabase();
        let dbTasks = await db.getTasks();

        // Added logic to ensure daily quote persistence (the same quote should be displayed for a given day).
        let prevUpdate = dbTasks.find(task => task.id === "prevUpdate") || { value: null };
        let currQuote = dbTasks.find(task => task.id === "dailyQuote") || { value: null };
        
        try {
          if (currentDay !== prevUpdate.value) {
            // Utilized the following API endpoint (https://zenquotes.io/api/random) to generate random quotes. 
            // Needed to resolved CORS issues by setting up CORS middleware
            let quotes = await fetch("https://api.allorigins.win/raw?url=https://zenquotes.io/api/random");

            let quoteData = await quotes.json();
            console.log(quoteData);
            if (quoteData && quoteData.length > 0) {
              let quoteSpecific = {quote: quoteData[0].q, person: quoteData[0].a};
              await db.addTask({id: "prevUpdate", value: currentDay});
              await db.addTask({id: "dailyQuote", value: JSON.stringify(quoteSpecific)});
              renderQuote(quoteSpecific);
            } else {
              throw new Error("No quote data available");
            }
          }
          else if (currQuote.value) {
            let quoteSpecific = JSON.parse(currQuote.value);
            renderQuote(quoteSpecific);
          } else {
            throw new Error("No previous quote data available");
          }
        } catch (error) {
          console.error("Error loading quote:", error);
          renderQuote({quote: "Keep pushing forward!", person: "Unknown"});
        }
      }

      function renderQuote(data) {
        let quoteDisplay = document.createElement("div");

        let dailyQuote = document.createElement("p");
        dailyQuote.classList.add("quote");
        dailyQuote.textContent = `"${data.quote}"`;

        let quoter = document.createElement("p");
        quoter.classList.add("person");
        quoter.textContent = data.person;

        quoteDisplay.appendChild(dailyQuote);
        quoteDisplay.appendChild(quoter);

        let quoteBox = document.getElementById("quote-box");
        quoteBox.innerHTML = "";
        quoteBox.appendChild(quoteDisplay);
      }

      //need to publish an event when the time ends, so that the trending/feed/saved pages can be cleared
      function publishResetEvent() {
        const hub = EventHub.getInstance();
        hub.publish(Events.Reset);
      }

      function dailyUpdate() {
        let currDay = new Date();
        let nextDay = new Date(
          currDay.getFullYear(),
          currDay.getMonth(),
          currDay.getDate() + 1,
          0,
          0,
          0,
        );
        let remainingTime = nextDay.getTime() - currDay.getTime();

        //added part such that when the time ends, other views will clear pages.
        setTimeout(async () => {
          publishResetEvent();
          await loadQuote();
          dailyUpdate();
        }, remainingTime);
      }

      async function start() {
        await loadQuote();
        dailyUpdate();
      }

      start();

      SpotifyLogin();
    </script>
  </body>
</html>


<!-- previous loadQuote function (with mocked quote data)
async function loadQuote() {
  let currentDay = new Date().toLocaleDateString();
  await db.openDatabase();
  let dbTasks = await db.getTasks();

  let quoteIndex = 0;
  let prevUpdate = null;

  for (let i = 0; i < dbTasks.length; i++) {
    if (dbTasks[i].id === "prevUpdate") {
      prevUpdate = dbTasks[i].value;
    }
    if (dbTasks[i].id === "index") {
      quoteIndex = dbTasks[i].value;
    }
  }

  try {
    let quotes = await fetch("quotes.json").then((res) => res.json());

    if (currentDay !== prevUpdate) {
      if (quoteIndex === null || quoteIndex >= quotes.length - 1) {
        await db.addTask({ id: "index", value: 0 });
        quoteIndex = 0;
      } else {
        quoteIndex++;
        await db.addTask({ id: "index", value: quoteIndex });
      }
      await db.addTask({ id: "prevUpdate", value: currentDay });
    }
    renderQuote(quotes[quoteIndex]);
  } catch (error) {
    console.error("Error loading quote:", error);
  }
} -->
