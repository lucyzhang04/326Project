<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remind.me</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
      <div id="navbar"></div>
      <div class="daily-quote">
        <h1 class="headerLeftAlign">Today's Quote is...</h1>
        <div class="quote-box" id="quote-box"></div>
      </div>

      <script type="module">
        fetch('navbar.html')
          .then(response => response.text())
          .then(data => {
            document.getElementById('navbar').innerHTML = data;
            
            const navLinkEls = document.querySelectorAll('.nav__link');
            const windowPathname = window.location.pathname;

            navLinkEls.forEach(navLinkEl => {
                if (navLinkEl.href.includes(windowPathname)) {
                    navLinkEl.classList.add('active');
                }
            });
          })
          .catch(error => console.error('Error loading navbar:', error));

         import {TaskDatabase} from './database.js';
         let db = new TaskDatabase('quotesDB');


         async function loadQuote() {
            let currentDay = new Date().toLocaleDateString();
            let dbTasks = await db.getTasks();

            let quoteIndex = 0;
            let prevUpdate = null;

            for (let i = 0; i < dbTasks.length; i++) {
              if (dbTasks[i].id === "prevUpdate") {
                prevUpdate = dbTasks[i].value;
              }
              if (dbTasks[i].id === 'index') {
                quoteIndex = dbTasks[i].value;
              }
            }

            try {
              let quotes = await fetch('quotes.json')
              .then(res => res.json());
              
                if(currentDay !== prevUpdate) {
                  if (quoteIndex === null || quoteIndex >= quotes.length - 1) {
                    await db.addTask({id: 'index', value: 0});
                    quoteIndex = 0;
                  } else {
                    quoteIndex++;
                    await db.addTask({id: 'index', value: quoteIndex});
                  }
                  await db.addTask({id: 'prevUpdate', value: currentDay});
                }
              renderQuote(quotes[quoteIndex]);
            }
            catch (error) {
              console.error('Error loading quote:', error);
            } 
          }

          function renderQuote(data) {
            let quoteDisplay = document.createElement('div');

            let dailyQuote = document.createElement('p');
            dailyQuote.classList.add("quote");
            dailyQuote.textContent = `"${data.quote}"`;

            let quoter = document.createElement('p');
            quoter.classList.add("person");
            quoter.textContent = data.person;

            quoteDisplay.appendChild(dailyQuote);
            quoteDisplay.appendChild(quoter);

            let quoteBox = document.getElementById("quote-box");
            quoteBox.innerHTML = "";
            quoteBox.appendChild(quoteDisplay);
          }

          function dailyUpdate() {
            let currDay = new Date();
            let nextDay = new Date(currDay.getFullYear(), currDay.getMonth(), currDay.getDate() + 1, 0, 0, 0);
            let remainingTime = nextDay.getTime() - currDay.getTime();

            setTimeout(async () => {
              await loadQuote();
              dailyUpdate();
            }, remainingTime);
          }

          async function start() {
            await loadQuote();
            dailyUpdate();
          }
          
          start();
    </script>
    
  </body>
</html>
